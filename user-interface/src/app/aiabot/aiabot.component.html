<div class="uk-section-default uk-section">
  <div class="uk-container">
    <h2 i18n="@@zrdbQuery">KI-Servicestelle AI Act Chatbot</h2>
  </div>

  <div class="uk-container">
    <div class="uk-container">
      <p class="uk-text-large uk-margin-top">
        Sie haben Fragen zum AI Act und regulatorischen Rahmenbedingungen zu AI?
        <br />
        Unser <a>RAG</a>-Chatbot beantwortet Ihre Fragen!
      </p>

      <h3>Stellen Sie Ihre Frage!</h3>
      <form class="uk-form uk-padding-remove">
        <p>
          <label class="uk-margin-medium-bottom">Ihre Frage: </label>
        </p>
        <div style="position: relative;">
          <textarea
            class="uk-input"
            placeholder="Stellen Sie uns Ihre Frage zum AI Act"
            [style.height]="'auto'"
            style="resize: none;"
            [(ngModel)]="userPrompt"
            name="userPrompt"
            (input)="onInput($event)"
            [maxlength]="maxLength"
          ></textarea>
          <small style="position: absolute; bottom: 5px; right: 10px; color: #888;">
            {{ userPrompt.length }}/{{ maxLength }}
          </small>
        </div> 
        <p>
          <a
            class="uk-button uk-button-large uk-button-primary"
            [ngClass]="step == 'initial' || step == 'done' ? '' : 'uk-disabled'"
            (click)="playDemo()"
            >Frage stellen</a
          >
        </p>
      </form>
      <p class="text-muted">
        <a>Weitere Informationen zum Chatbot</a>
      </p>
    </div>
    <div *ngIf="step != 'initial'">
      <div class="uk-container uk-margin-top-50">
        <h3>
          <img
            src="assets/buffering.gif"
            class="spinner"
            *ngIf="step == 'research'"
          />
          <span *ngIf="step != 'research'">&check;</span>
          Relevante Quellen erheben <i>(&ldquor;<b>R</b>etrieve&rdquor;)</i>
        </h3>
          <ul
                  uk-accordion
                  class="uk-accordion ac-content"
                  *ngIf="sources.length > 0"
          >
              <li class="">
                  <a class="uk-accordion-title anchor" aria-expanded="true">
                      <b>
                          <ng-container>{{ getTotalSources(sources) }}</ng-container>
                          möglicherweise relevante Quellen identifiziert</b>
                  </a>
                  <div class="uk-accordion-content">
                      <div><i>Hinweis: </i> {{ getNotSkippedSources(sources) }} in schwarzer Schrift
                          abgebildete Dokumente werden zur
                          Fragenbeantwortung herangezogen. Grau abgebildete Einträge überschreiten
                          das
                          Kontextfenster und bleiben deshalb unberücksichtigt.
                      </div>
                      <ol class="references">
                          <li *ngFor="let source of sources; let i = index">
                              <a
                                      (click)="toggleAccordion(i+1)"
                                      [style.color]="source.skip ? 'darkgray' : 'black'"
                              >
                                  {{ source.title || "Quelle" }} ({{ formatScore(source.score) }})
                                  ({{ source.num_tokens }} Token)
                              </a>
                              <div
                                      id="content-{{ (i+1) }}"
                                      class="source-content uk-hidden"
                                      style="margin-left: 20px"
                              >
                                  {{ source.content }}
                              </div>

                              <ol style="margin-left: 20px;" class="sub-references">
                                  <li
                                          *ngFor="let chunk of source.relevantChunks; let j=index"
                                  >
                                      <a (click)="toggleAccordion((i+1)*1000+j)"
                                         [style.color]="chunk.skip ? 'darkgray' : 'black'"
                                      >{{ chunk.title.length > 0 ? chunk.title : chunk.id }}
                                          ({{ chunk.num_tokens }} Token)
                                      </a>
                                      <div
                                              id="content-{{ ((i+1)*1000+j) }}"
                                              class="source-content uk-hidden"
                                              style="margin-left: 20px"
                                      >
                                          {{ chunk.content }}
                                      </div>
                                  </li>
                              </ol>
                          </li>
                      </ol>
                  </div>
              </li>
          </ul>
        <p *ngIf="tokensUsedFormatted.length > 0">
          Gesamtanzahl Token: {{tokensUsedFormatted}}
        </p>
        <p *ngIf="sources.length > 0">
          <i><a>Information: Wie werden relevante Quellen erhoben?</a></i>
        </p>
      </div>

      <div class="uk-container uk-margin-top-50">
        <h3>
          <img
            src="assets/buffering.gif"
            class="spinner"
            *ngIf="step == 'prompt'"
          />
          <span *ngIf="step == 'done' || step == 'output'">&check;</span>
          Prompt erstellen <i>(&ldquor;<b>A</b>ugment&rdquor;)</i>
        </h3>
        <ul
          uk-accordion
          class="uk-accordion ac-content"
          *ngIf="prompt.length > 0"
        >
          <li class="">
            <a class="uk-accordion-title anchor" aria-expanded="true">
              <b>Prompt</b>
            </a>
            <div class="uk-accordion-content">
              <p [innerHTML]="prompt"></p>
            </div>
          </li>
        </ul>
      </div>

      <div class="uk-container uk-margin-top-50">
        <h3>
          <img
            src="assets/buffering.gif"
            class="spinner"
            *ngIf="step == 'output'"
          />
          <span *ngIf="step == 'done'">&check;</span>
          Antwort erstellen <i>(&ldquor;<b>G</b>enerate&rdquor;)</i>
        </h3>
        <blockquote *ngIf="displayAnswer.length > 0">
          <p [innerHTML]="displayAnswer"></p>
        </blockquote>
      </div>
    
      <form  *ngIf="step == 'done'" class="uk-form uk-padding-remove uk-margin-top">
          <p class="uk-margin-remove-bottom">
              <strong>Wichtiger Hinweis: </strong> Bitte beachten Sie, dass die obige Antwort von
              einer KI erstellt wurde und möglicherweise Fehler enthalten kann.
              Für fachkundige Unterstützung steht Ihnen das Team der <a href="https://ki.rtr.at" target="_blank">KI-Servicestelle</a> gerne zur
              Verfügung.
          </p>
          <div *ngIf="feedbackFormVisible" style="position: relative;">
              <p class="uk-margin-top">
                  <label class="uk-margin-medium-bottom">Ihr Feedback:</label>
              </p>
              <textarea
                      class="uk-input"
                      [style.height]="'auto'"
                      style="resize: none;"
                      [(ngModel)]="feedbackText"
                      name="feedback"
                      (input)="onInput($event)"
                      [maxlength]="maxLength"
              ></textarea>
              <small style="position: absolute; bottom: 5px; right: 10px; color: #888;">
                  {{ feedbackText.length }}/{{ maxLength }}
              </small>
          </div>
          <p class="uk-margin-remove-top">
              <button
                      class="uk-button uk-button-primary"
                      (click)="onFeedBackButtonPressed()"
              > <span *ngIf="feedbackFormVisible; else formNotVisibled">Feedback absenden</span>
                  <ng-template #formNotVisibled>Feedback zu dieser Antwort senden</ng-template>
              </button
              >
          </p>
      </form>
      <span *ngIf="step == 'done'">
        <p><strong>Energieverbrauch: </strong>
        Diese Fragenbeantwortung hat einen Stromverbrauch von <strong>{{ totalConsumption.total_kWh.toFixed(6).replace(".", ",") }} kWh</strong>  verursacht.
            Mit dieser Strommenge kann etwa ein Haarfön für  <i>{{ (totalConsumption.total_kWh*1000*2200/60/60).toFixed(2).replace(".", ",") }} Sekunden</i> betrieben,
            oder ein Handyakku um <i>{{ (totalConsumption.total_kWh*1000/5*1000/5000*0.80*100).toFixed(2).replace(".", ",") }}&nbsp;%</i> aufgeladen werden.
        </p>
       
      </span>
      <ul
          uk-accordion
          class="uk-accordion ac-content"
          *ngIf="step == 'done'"
        >
          <li class="">
            <a class="uk-accordion-title anchor" aria-expanded="true">
              <b>Detaillierte Infos zum Energieverbrauch</b>
            </a>
            <div class="uk-accordion-content">
               <div  class="table-container">
        <table class="uk-table uk-table-hover">
          <thead>
            <tr>
              <th><span uk-icon="bolt"></span> Energieverbrauch</th>
              <th>Prozessor (CPU)</th>
              <th>Grafikkarte (GPU)</th>
              <th>Arbeitsspeicher (RAM)</th>
              <th>Gesamt</th>
              <th>Dauer</th>

            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of powerData">
              <td>{{ row.label }}</td>
              <td>{{ row.cpu_kWh.toFixed(6).replace(".", ",") }} kWh</td>
              <td>{{ row.gpu_kWh.toFixed(6).replace(".", ",") }} kWh</td>
              <td>{{ row.ram_kWh.toFixed(6).replace(".", ",")  }} kWh </td>
              <td>{{ row.total_kWh.toFixed(6).replace(".", ",") }} kWh</td>
              <td>{{ row.duration.toFixed(2).replace(".", ",") }} Sek.</td>
            </tr>
            <tr>
              <td><strong>Gesamt</strong></td>
              <td><strong>{{ totalConsumption.cpu_kWh.toFixed(6).replace(".", ",") }} kWh</strong></td>
              <td><strong>{{ totalConsumption.gpu_kWh.toFixed(6).replace(".", ",") }} kWh</strong></td>
              <td><strong>{{ totalConsumption.ram_kWh.toFixed(6).replace(".", ",")  }} kWh</strong></td>
              <td><strong>{{ totalConsumption.total_kWh.toFixed(6).replace(".", ",") }} kWh</strong></td>
              <td><strong>{{ totalConsumption.duration.toFixed(2).replace(".", ",") }} Sek.</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
            </div>
          </li>
        </ul>
   
    </div>
    <div class="uk-container uk-margin-top-50">
      <h4>Hintergrundinformationen zum AI Act Chatbot</h4>
      <ul>
        <li><a>Datenschutz</a></li>
        <li><a>Technische Ausführung und Source Code</a></li>
        <li><a>Chatbots und der AI Act</a></li>
        <li><a>Softwarelizenzen</a></li>
        <li><a>Datenstand, Datenbasis, Datenaufbereitung</a></li>
        <li><a>Umweltaspekte</a></li>
      </ul>
    </div>
  </div>
</div>
