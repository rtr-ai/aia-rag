<div class="uk-section-default uk-section">
  <div class="uk-container">
    <h2 i18n="@@zrdbQuery">KI-Servicestelle AI Act Chatbot</h2>
  </div>

  <div class="uk-container">
    <div class="uk-container">
      <p class="uk-text-large uk-margin-top">
        Sie haben Fragen zum AI Act und regulatorischen Rahmenbedingungen zu AI?
        <br />
        Unser <a>RAG</a>-Chatbot beantwortet Ihre Fragen!
      </p>

      <h3>Stellen Sie Ihre Frage!</h3>
      <form class="uk-form uk-padding-remove">
        <p>
          <label class="uk-margin-medium-bottom">Ihre Frage: </label>
        </p>
        <div style="position: relative;">
          <textarea
            class="uk-input"
            [style.height]="'auto'"
            style="resize: none;"
            [(ngModel)]="userPrompt"
            name="userPrompt"
            (input)="onInput($event)"
            [maxlength]="maxLength"
          ></textarea>
          <small style="position: absolute; bottom: 5px; right: 10px; color: #888;">
            {{ userPrompt.length }}/{{ maxLength }}
          </small>
        </div> 
        <p>
          <a
            class="uk-button uk-button-large uk-button-primary"
            [ngClass]="step == 'initial' || step == 'done' ? '' : 'uk-disabled'"
            (click)="playDemo()"
            >Frage stellen</a
          >
        </p>
      </form>
      <p class="text-muted">
        <a>Weitere Informationen zum Chatbot</a>
      </p>
    </div>
    <div *ngIf="step != 'initial'">
      <div class="uk-container uk-margin-top-50">
        <h3>
          <img
            src="assets/buffering.gif"
            class="spinner"
            *ngIf="step == 'research'"
          />
          <span *ngIf="step != 'research'">&check;</span>
          Relevante Quellen erheben <i>(&ldquor;<b>R</b>etrieve&rdquor;)</i>
        </h3>
        <h4 *ngIf="sources.length > 0">Relevante Quellen</h4>
        <ul>
          <li *ngFor="let source of sources; let i = index">
            <a 
              (click)="toggleAccordion(i)"
              [style.color]="source.skip ? 'darkgray' : 'black'"
            >
            {{ source.title || "Quelle" }} ({{ formatScore(source.score) }}) ({{source.num_tokens}} Token)
            </a>
            <ul style="margin-left: 20px;">
              <li 
                *ngFor="let chunk of source.relevantChunks"
                [style.color]="chunk.skip ? 'darkgray' : 'black'"
              >
              {{ chunk.title.length > 0 ? chunk.title : chunk.id }} ({{chunk.num_tokens}} Token)
              </li>
            </ul>
            <div
              id="content-{{ i }}"
              class="accordion-content"
              style="display: none; margin-left: 20px"
            >
              {{ source.content }}
            </div>
          </li>
        </ul>
        <p *ngIf="tokensUsedFormatted.length > 0">
          Gesamtanzahl Token: {{tokensUsedFormatted}}
        </p>
        <p *ngIf="sources.length > 0">
          <i><a>Information: Wie werden relevante Quellen erhoben?</a></i>
        </p>
      </div>

      <div class="uk-container uk-margin-top-50">
        <h3>
          <img
            src="assets/buffering.gif"
            class="spinner"
            *ngIf="step == 'prompt'"
          />
          <span *ngIf="step == 'done' || step == 'output'">&check;</span>
          Prompt erstellen <i>(&ldquor;<b>A</b>ugment&rdquor;)</i>
        </h3>
        <ul
          uk-accordion
          class="uk-accordion ac-content"
          *ngIf="prompt.length > 0"
        >
          <li class="">
            <a class="uk-accordion-title anchor" aria-expanded="true">
              <b>Prompt</b>
            </a>
            <div class="uk-accordion-content">
              <p [innerHTML]="prompt"></p>
            </div>
          </li>
        </ul>
      </div>

      <div class="uk-container uk-margin-top-50">
        <h3>
          <img
            src="assets/buffering.gif"
            class="spinner"
            *ngIf="step == 'output'"
          />
          <span *ngIf="step == 'done'">&check;</span>
          Antwort erstellen <i>(&ldquor;<b>G</b>enerate&rdquor;)</i>
        </h3>
        <blockquote *ngIf="displayAnswer.length > 0">
          <p [innerHTML]="displayAnswer"></p>
        </blockquote>
      </div>
    
      <form  *ngIf="step == 'done'" class="uk-form uk-padding-remove">
        <div *ngIf="feedbackFormVisible"  style="position: relative;" >
        <p>
          <label class="uk-margin-medium-bottom">Ihr Feedback:</label>
        </p>
          <textarea
            class="uk-input"
            [style.height]="'auto'"
            style="resize: none;"
            [(ngModel)]="feedbackText"
            name="feedback"
            (input)="onInput($event)"
            [maxlength]="maxLength"
          ></textarea>
          <small style="position: absolute; bottom: 5px; right: 10px; color: #888;">
            {{ feedbackText.length }}/{{ maxLength }}
          </small>
        </div> 
        <p>
          <a
            class="uk-button uk-button-primary"
            (click)="onFeedBackButtonPressed()"
            > <span *ngIf="feedbackFormVisible; else formNotVisibled">Feedback absenden</span>
            <ng-template #formNotVisibled>Feedback zu dieser Antwort senden</ng-template>
            </a
          >
        </p>
      </form>
      <div  *ngIf="step == 'done'" class="table-container">
        <table class="uk-table uk-table-hover">
          <thead>
            <tr>
              <th><span uk-icon="bolt"></span> Energieverbrauch</th>
              <th>Prozessor (CPU)</th>
              <th>Grafikkarte (GPU)</th>
              <th>Arbeitsspeicher (RAM)</th>
              <th>Gesamt</th>
              <th>Dauer</th>

            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of powerData">
              <td>{{ row.label }}</td>
              <td>{{ row.cpu_kWh.toFixed(6).replace(".", ",") }} kWh</td>
              <td>{{ row.gpu_kWh.toFixed(6).replace(".", ",") }} kWh</td>
              <td>{{ row.ram_kWh.toFixed(6).replace(".", ",")  }} kWh </td>
              <td>{{ row.total_kWh.toFixed(6).replace(".", ",") }} kWh</td>
              <td>{{ row.duration.toFixed(2).replace(".", ",") }} Sek.</td>
            </tr>
            <tr>
              <td><strong>Gesamt</strong></td>
              <td><strong>{{ totalConsumption.cpu_kWh.toFixed(6).replace(".", ",") }} kWh</strong></td>
              <td><strong>{{ totalConsumption.gpu_kWh.toFixed(6).replace(".", ",") }} kWh</strong></td>
              <td><strong>{{ totalConsumption.ram_kWh.toFixed(6).replace(".", ",")  }} kWh</strong></td>
              <td><strong>{{ totalConsumption.total_kWh.toFixed(6).replace(".", ",") }} kWh</strong></td>
              <td><strong>{{ totalConsumption.duration.toFixed(2).replace(".", ",") }} Sek.</strong></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="uk-container uk-margin-top-50">
      <h4>Hintergrundinformationen zum AI Act Chatbot</h4>
      <ul>
        <li><a>Datenschutz</a></li>
        <li><a>Technische Ausf√ºhrung und Source Code</a></li>
        <li><a>Chatbots und der AI Act</a></li>
        <li><a>Softwarelizenzen</a></li>
        <li><a>Datenstand, Datenbasis, Datenaufbereitung</a></li>
        <li><a>Umweltaspekte</a></li>
      </ul>
    </div>
  </div>
</div>
